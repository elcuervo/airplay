#!/usr/bin/env ruby

require "clap"

require "airplay/cli"
require "airplay/cli/version"

begin
  device, url, wait, interactive, password = false

  arguments = Clap.run ARGV,
    "--device"      => -> device_name { device = Airplay[device_name] },
    "--url"         => -> url { url = url },
    "--wait"        => -> sec { wait = sec.to_i },
    "--password"    => -> pass { password = pass},
    "--interactive" => -> { interactive = true }

 Clap.run arguments,
   "help"    => Airplay::CLI.method(:help),
   "list"    => Airplay::CLI.method(:list),
   "doctor"  => Airplay::CLI.method(:doctor),
   "version" => Airplay::CLI.method(:version),

   "play" => lambda { |video|
     options = {
       device: device || Airplay.devices.first,
       password: password || false,
       url: url || false
     }

     Airplay::CLI.play(video, options)
   },

   "view" => lambda { |file|
     device = if !url
       device || Airplay.devices.first
     else
       false
     end

     options = {
       device: device,
       interactive: interactive || false,
       password: password || false,
       url: url || false,
       wait: wait || 3
     }

     Airplay::CLI.view(file, options)
   }

   Airplay::CLI.help if ARGV.empty?

rescue Airplay::Browser::NoDevicesFound
  puts "No devices found."
rescue Interrupt
  puts "Bye!"
end

# vim: ft=ruby
